<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Resume AI">
    <meta name="application-name" content="Resume AI">
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='icons/icon-152x152.png') }}">
    <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}" color="#6366f1">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <title>{% block title %}AI Resume Optimizer{% endblock %}</title>
    
    <!-- Bootstrap CSS (Replit Dark Theme) -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom Mobile App CSS -->
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Mobile App Header -->
    <header class="mobile-header">
        <h1>
            <i class="fas fa-robot me-2"></i>{% block header_title %}AI Resume Optimizer{% endblock %}
        </h1>
        <div class="header-actions">
            {% block header_actions %}
            <button class="btn" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fas fa-palette"></i>
            </button>
            {% endblock %}
        </div>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show animate-slide-up" role="alert">
                        <i class="fas fa-{{ 'exclamation-circle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav mobile-safe-area">
        <a href="{{ url_for('index') }}" class="nav-item {{ 'active' if request.endpoint == 'index' }}">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="{{ url_for('upload') }}" class="nav-item {{ 'active' if request.endpoint == 'upload' }}">
            <i class="fas fa-plus-circle"></i>
            <span>Upload</span>
        </a>
        <button class="nav-item" onclick="showAppInfo()" style="background: none; border: none;">
            <i class="fas fa-info-circle"></i>
            <span>About</span>
        </button>
    </nav>

    <!-- App Info Modal -->
    <div class="modal fade" id="appInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-robot me-2 text-gradient"></i>AI Resume Optimizer
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-robot fa-4x text-gradient"></i>
                    </div>
                    <h6 class="text-gradient mb-3">Mobile App Experience</h6>
                    <p class="text-secondary">
                        Transform your resume with AI-powered optimization. Upload your resume, get instant analysis, and download professional formats.
                    </p>
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <div class="text-center">
                            <i class="fas fa-upload fa-2x text-gradient mb-2"></i>
                            <p class="small text-muted mb-0">Upload</p>
                        </div>
                        <div class="text-center">
                            <i class="fas fa-brain fa-2x text-gradient mb-2"></i>
                            <p class="small text-muted mb-0">Analyze</p>
                        </div>
                        <div class="text-center">
                            <i class="fas fa-download fa-2x text-gradient mb-2"></i>
                            <p class="small text-muted mb-0">Download</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <small class="text-muted">Built with Python, Flask, spaCy, NLTK, and ❤️</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Mobile App JS -->
    <script>
        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme colors
            if (newTheme === 'light') {
                document.documentElement.style.setProperty('--app-bg', '#f8f9fa');
                document.documentElement.style.setProperty('--text-primary', '#333333');
                document.documentElement.style.setProperty('--text-secondary', 'rgba(0, 0, 0, 0.7)');
                document.documentElement.style.setProperty('--card-bg', 'rgba(255, 255, 255, 0.8)');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.2)');
                document.documentElement.style.setProperty('--border-glass', 'rgba(0, 0, 0, 0.1)');
            } else {
                document.documentElement.style.setProperty('--app-bg', '#0f0f0f');
                document.documentElement.style.setProperty('--text-primary', '#ffffff');
                document.documentElement.style.setProperty('--text-secondary', 'rgba(255, 255, 255, 0.7)');
                document.documentElement.style.setProperty('--card-bg', 'rgba(255, 255, 255, 0.08)');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.05)');
                document.documentElement.style.setProperty('--border-glass', 'rgba(255, 255, 255, 0.18)');
            }
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-bs-theme', savedTheme);
                if (savedTheme === 'light') {
                    document.documentElement.style.setProperty('--app-bg', '#f8f9fa');
                    document.documentElement.style.setProperty('--text-primary', '#333333');
                    document.documentElement.style.setProperty('--text-secondary', 'rgba(0, 0, 0, 0.7)');
                    document.documentElement.style.setProperty('--card-bg', 'rgba(255, 255, 255, 0.8)');
                    document.documentElement.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.2)');
                    document.documentElement.style.setProperty('--border-glass', 'rgba(0, 0, 0, 0.1)');
                }
            }
            
            // Add animation classes to elements
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('animate-fade-scale');
            });
            
            // Add haptic feedback for mobile (if supported)
            if ('vibrate' in navigator) {
                document.querySelectorAll('.btn, .nav-item').forEach(element => {
                    element.addEventListener('click', () => {
                        navigator.vibrate(50);
                    });
                });
            }
        });

        // Show app info modal
        function showAppInfo() {
            const modal = new bootstrap.Modal(document.getElementById('appInfoModal'));
            modal.show();
        }

        // Add touch feedback for mobile interactions
        document.addEventListener('touchstart', function(e) {
            if (e.target.matches('.btn, .card, .nav-item, .form-control')) {
                e.target.style.transform = 'scale(0.98)';
                e.target.style.transition = 'transform 0.1s';
            }
        });

        document.addEventListener('touchend', function(e) {
            if (e.target.matches('.btn, .card, .nav-item, .form-control')) {
                setTimeout(() => {
                    e.target.style.transform = '';
                }, 100);
            }
        });

        // Prevent zoom on double tap for mobile app experience
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Add pull-to-refresh effect (visual only)
        let startY = 0;
        let pullDistance = 0;
        const refreshThreshold = 100;

        document.addEventListener('touchstart', function(e) {
            if (window.scrollY === 0) {
                startY = e.touches[0].pageY;
            }
        });

        document.addEventListener('touchmove', function(e) {
            if (window.scrollY === 0 && startY < e.touches[0].pageY) {
                pullDistance = e.touches[0].pageY - startY;
                if (pullDistance > 0 && pullDistance < refreshThreshold) {
                    document.body.style.transform = `translateY(${pullDistance * 0.5}px)`;
                    document.body.style.opacity = 1 - (pullDistance / refreshThreshold * 0.3);
                }
            }
        });

        document.addEventListener('touchend', function(e) {
            if (pullDistance > refreshThreshold) {
                // Trigger refresh action
                window.location.reload();
            }
            document.body.style.transform = '';
            document.body.style.opacity = '';
            pullDistance = 0;
        });
    </script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
        
        // PWA Install prompt (disabled)
        window.addEventListener('beforeinstallprompt', function(e) {
            e.preventDefault();
            // Install prompt is disabled - users can still install via browser menu
        });
        
        function showUpdateNotification() {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'alert alert-info position-fixed w-100';
            updateBanner.style.cssText = 'top: 0; z-index: 1001; margin: 0; border-radius: 0;';
            updateBanner.innerHTML = `
                <div class="container d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-info-circle me-2"></i>A new version is available!</span>
                    <button class="btn btn-sm btn-outline-info" onclick="updateApp()">Update</button>
                </div>
            `;
            document.body.prepend(updateBanner);
        }
        
        function updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    registrations.forEach(function(registration) {
                        registration.unregister();
                    });
                    window.location.reload();
                });
            }
        }
        
        // Offline status handling
        function updateOnlineStatus() {
            const offlineIndicator = document.getElementById('offlineIndicator');
            
            if (!navigator.onLine) {
                if (!offlineIndicator) {
                    const indicator = document.createElement('div');
                    indicator.id = 'offlineIndicator';
                    indicator.className = 'alert alert-warning position-fixed w-100';
                    indicator.style.cssText = 'bottom: 0; z-index: 1001; margin: 0; border-radius: 0;';
                    indicator.innerHTML = `
                        <div class="container text-center">
                            <i class="fas fa-wifi-slash me-2"></i>
                            You're offline. Some features may not work.
                        </div>
                    `;
                    document.body.appendChild(indicator);
                }
            } else {
                if (offlineIndicator) {
                    offlineIndicator.remove();
                }
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Check initial status
        document.addEventListener('DOMContentLoaded', updateOnlineStatus);
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>