{% extends "base.html" %}

{% block title %}Upload Resume - AI Resume Optimizer{% endblock %}

{% block header_title %}Upload Resume{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Upload Section -->
    <section class="app-section">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-6">
                <div class="card animate-fade-scale">
                    <div class="card-header text-center">
                        <i class="fas fa-cloud-upload-alt fa-3x text-gradient mb-3"></i>
                        <h3 class="text-gradient mb-0">Create or Optimize Resume</h3>
                        <p class="text-secondary small mb-0">AI-powered optimization and generation in seconds</p>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data" id="uploadForm">
                            <!-- File Upload Area -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-file-alt me-2"></i>Resume File <span class="text-muted">(Optional)</span>
                                </label>
                                <div class="file-upload-area" id="fileUploadArea">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <h5 class="mt-3 mb-2">Drop your resume here to optimize</h5>
                                    <p class="text-secondary mb-3">or click to browse files â€¢ <strong>Leave empty to generate new resume</strong></p>
                                    <div class="supported-formats">
                                        <span class="badge bg-primary me-2">PDF</span>
                                        <span class="badge bg-primary me-2">DOCX</span>
                                        <span class="badge bg-primary">TXT</span>
                                    </div>
                                    <input type="file" name="resume_file" id="resumeFile" 
                                           accept=".pdf,.docx,.txt" 
                                           style="display: none;">
                                </div>
                                <div id="fileInfo" class="mt-3" style="display: none;">
                                    <div class="d-flex align-items-center p-3 rounded" 
                                         style="background: var(--glass-bg); border: 1px solid var(--border-glass);">
                                        <i class="fas fa-file-alt fa-2x me-3 text-gradient"></i>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0" id="fileName"></h6>
                                            <small class="text-secondary" id="fileSize"></small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Job Description -->
                            <div class="mb-4">
                                <label for="job_description" class="form-label">
                                    <i class="fas fa-briefcase me-2"></i>Job Description
                                </label>
                                <textarea name="job_description" id="job_description" 
                                          class="form-control" rows="8" required
                                          placeholder="Paste the job description you're applying for. This helps our AI optimize your resume with relevant keywords and skills."></textarea>
                                <div class="form-text">
                                    <i class="fas fa-lightbulb me-1 text-warning"></i>
                                    <small>Include the full job posting for best keyword matching results</small>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="fas fa-brain me-2"></i><span id="submitText">Optimize My Resume</span>
                                </button>
                                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Home
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Feature Highlights -->
    <section class="app-section">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="stats-card animate-slide-left">
                    <i class="fas fa-zap"></i>
                    <h6 class="mb-2">Lightning Fast</h6>
                    <p class="text-secondary small mb-0">Analysis completed in seconds</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card animate-slide-left" style="animation-delay: 0.1s;">
                    <i class="fas fa-shield-alt"></i>
                    <h6 class="mb-2">Secure & Private</h6>
                    <p class="text-secondary small mb-0">Your data is processed locally</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card animate-slide-left" style="animation-delay: 0.2s;">
                    <i class="fas fa-magic"></i>
                    <h6 class="mb-2">AI-Powered</h6>
                    <p class="text-secondary small mb-0">Advanced NLP & ML algorithms</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Tips Section -->
    <section class="app-section">
        <div class="card glass-effect">
            <div class="card-body">
                <h5 class="text-gradient mb-3">
                    <i class="fas fa-lightbulb me-2"></i>Pro Tips for Best Results
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex">
                            <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                            <div>
                                <h6 class="mb-1">Complete Job Description</h6>
                                <small class="text-secondary">Include the entire job posting for accurate keyword analysis</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex">
                            <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                            <div>
                                <h6 class="mb-1">Clear Format</h6>
                                <small class="text-secondary">Use well-formatted PDFs or Word documents</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex">
                            <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                            <div>
                                <h6 class="mb-1">Complete Information</h6>
                                <small class="text-secondary">Include all relevant experience and skills</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex">
                            <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                            <div>
                                <h6 class="mb-1">Recent Resume</h6>
                                <small class="text-secondary">Use your most up-to-date resume version</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <h5 class="text-gradient mb-3">Optimizing Your Resume</h5>
                <p class="text-secondary mb-3" id="loadingText">Analyzing your resume content...</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-animated" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('resumeFile');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const form = document.getElementById('uploadForm');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    // File upload area interactions
    fileUploadArea.addEventListener('click', () => fileInput.click());
    
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });
    
    fileUploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            displayFileInfo(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            displayFileInfo(e.target.files[0]);
        }
    });

    function displayFileInfo(file) {
        const size = (file.size / 1024 / 1024).toFixed(2);
        fileName.textContent = file.name;
        fileSize.textContent = `${size} MB`;
        fileInfo.style.display = 'block';
        fileUploadArea.style.display = 'none';
    }

    window.removeFile = function() {
        fileInput.value = '';
        fileInfo.style.display = 'none';
        fileUploadArea.style.display = 'block';
    }

    // Form submission with loading states
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading modal
        loadingModal.show();
        
        // Simulate loading progress
        const progressBar = document.getElementById('progressBar');
        const loadingText = document.getElementById('loadingText');
        let progress = 0;
        
        const messages = [
            'Extracting text from your resume...',
            'Analyzing content structure...',
            'Matching keywords with job description...',
            'Checking grammar and style...',
            'Calculating optimization score...',
            'Generating optimized formats...',
            'Finalizing analysis...'
        ];
        
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15 + 5;
            if (progress > 95) progress = 95;
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * messages.length);
            if (messageIndex < messages.length) {
                loadingText.textContent = messages[messageIndex];
            }
        }, 800);
        
        // Submit form
        const formData = new FormData(form);
        fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            loadingText.textContent = 'Complete! Redirecting...';
            
            if (response.ok) {
                return response.text();
            }
            throw new Error('Upload failed');
        })
        .then(html => {
            // Parse the response to see if it's a redirect or error
            if (html.includes('analyze')) {
                // Success - redirect will happen
                setTimeout(() => {
                    window.location.href = response.url;
                }, 1000);
            } else {
                // Parse and show any errors
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const alerts = doc.querySelectorAll('.alert');
                
                loadingModal.hide();
                
                if (alerts.length > 0) {
                    // Show error message
                    const container = document.querySelector('.container-fluid');
                    const alertHTML = alerts[0].outerHTML;
                    container.insertAdjacentHTML('afterbegin', alertHTML);
                }
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            loadingModal.hide();
            console.error('Upload error:', error);
            
            // Show error message
            const container = document.querySelector('.container-fluid');
            const errorAlert = `
                <div class="alert alert-danger alert-dismissible fade show animate-slide-up" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Upload failed. Please try again.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', errorAlert);
        });
        
        // Actually submit the form after a delay
        setTimeout(() => {
            form.submit();
        }, 2000);
    });

    // Add character counter for job description
    const jobDescription = document.getElementById('job_description');
    const charCounter = document.createElement('div');
    charCounter.className = 'form-text text-end';
    charCounter.innerHTML = '<small class="text-muted">0 characters</small>';
    jobDescription.parentNode.appendChild(charCounter);

    jobDescription.addEventListener('input', function() {
        const count = this.value.length;
        charCounter.innerHTML = `<small class="text-muted">${count.toLocaleString()} characters</small>`;
        
        if (count > 100) {
            charCounter.innerHTML = `<small class="text-success">${count.toLocaleString()} characters - Good length for analysis</small>`;
        }
    });

    // Auto-resize textarea
    jobDescription.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
});
</script>
{% endblock %}